//***********************************************************************
//**               Module 2 of Canopy Height Program                   **
//***********************************************************************
//** Reads data from .txt file generated by Module 1 and processes to  **
//** extract pulse location, amplitude and width.                      **
//** Authors: Karolina Fieber, Ian Davenport                           **
//** k.fieber@reading.ac.uk, i.j.davenport@reading.ac.uk               **
//** University of Reading, UK              November 2014 - March 2015 **
//***********************************************************************

#include<math.h>
#include<string.h>
#include<stdio.h>
#include<malloc.h>

double readindouble(FILE *fp)
{
	double scanned_number;
	char instring[200];
	int i;
	instring[0]=' ';
	for (i=1;(instring[i-1]!=',')&&(instring[i-1]!='\n')&&(i<99);i++)
		instring[i]=fgetc(fp);
	if (i<99)
	{
		instring[i-1]='\0';
		sscanf(instring,"%lf",&scanned_number);
	}
	else 
		scanned_number=-999;
	return scanned_number;
}

int readininteger(FILE *fp)
{
	int scanned_number;
	char instring[200];
	int i;
	instring[0]=' ';
	for (i=1;(instring[i-1]!=',')&&(instring[i-1]!='\n')&&(i<99);i++)
		instring[i]=fgetc(fp);
	if (i<99)
	{
		instring[i-1]='\0';
		sscanf(instring,"%ld",&scanned_number);
	}
	else 
		scanned_number=-999;
	return scanned_number;
}

/************************************************************************************************************************************************/
/*																FUNCTIONS																		*/
/************************************************************************************************************************************************/

int find_first_peak(double amplitude[] , int number_of_bins, double start_bin, double *peak_position_orig_passon, double *peak_position, double *peak_amplitude,double noise_estim, double mean_amplitude_trans)
{
	double first_peak_amplitude;
	double train_position_of_first_peak_amplitude,peak_position_original, SNR,amplitude_threshold;
	int train_counter;

	first_peak_amplitude=0;
	peak_position_original=start_bin-1;
	train_position_of_first_peak_amplitude=start_bin-1;

	SNR=noise_estim/mean_amplitude_trans;
	if (SNR<0.05)
		amplitude_threshold=noise_estim*3;
	else if (SNR<0.11)
		amplitude_threshold=noise_estim*1.5;
	else if (SNR<0.12)
		amplitude_threshold=noise_estim*1.3;
	else
		amplitude_threshold=noise_estim;

	for (train_counter=(int)start_bin;train_counter<=number_of_bins;train_counter++)
		{
			if 	((((amplitude[train_counter-1]<amplitude[train_counter])&&(amplitude[train_counter]>=amplitude[train_counter+1])&&(amplitude[train_counter]>=amplitude_threshold))&&
				((amplitude[train_counter]-amplitude[train_counter+2]>=2)||(amplitude[train_counter]-amplitude[train_counter-2]>=2)))
				||
				((amplitude[train_counter-2]<amplitude[train_counter-1])&&(amplitude[train_counter-1]<amplitude[train_counter]) /*merged peak on leading edge - inflection point*/
				&&(amplitude[train_counter]<=amplitude[train_counter+1])&&(amplitude[train_counter+1]<amplitude[train_counter+2])&&(amplitude[train_counter]>=amplitude_threshold)
				&&((((amplitude[train_counter+1]-amplitude[train_counter])/(amplitude[train_counter]-amplitude[train_counter-1]))<=0.25)
				||(((amplitude[train_counter+1]-amplitude[train_counter])/(amplitude[train_counter+2]-amplitude[train_counter+1]))<=0.25)))) 

				{
					first_peak_amplitude=amplitude[train_counter];
					train_position_of_first_peak_amplitude=train_counter;
					break;
				}
		}
		peak_position_original=train_position_of_first_peak_amplitude;
		if ((first_peak_amplitude==amplitude[train_counter+1])
			||((first_peak_amplitude-amplitude[train_counter-1])/(first_peak_amplitude-amplitude[train_counter+1])>2.7))
		{
			train_position_of_first_peak_amplitude=(train_counter+0.5);
		}

		if ((first_peak_amplitude==amplitude[train_counter+1])&&(first_peak_amplitude==amplitude[train_counter+2]))
		{
			train_position_of_first_peak_amplitude=(train_counter+1.0);
		}
			
		if ((first_peak_amplitude==amplitude[train_counter+1])&&(first_peak_amplitude==amplitude[train_counter+2])
			&&(first_peak_amplitude==amplitude[train_counter+2]))
		{
			train_position_of_first_peak_amplitude=(train_counter+1.5);
		}

		if (((first_peak_amplitude-amplitude[train_counter-1])>0)
			&&((first_peak_amplitude-amplitude[train_counter+1])/(first_peak_amplitude-amplitude[train_counter-1])>2.7))
		{
			train_position_of_first_peak_amplitude=(train_counter-0.5);
		}

		*peak_position_orig_passon=peak_position_original;
		*peak_position=train_position_of_first_peak_amplitude;
		*peak_amplitude=first_peak_amplitude;
	return(0);
}

int find_nth_peak(double amplitude[] , int number_of_bins, double start_bin, double nth_position, double nth_amplitude, 
	double *peak_position_orig_passon, double *peak_position, double *peak_amplitude, double noise_estim, double mean_width_transmitted, double mean_amplitude_trans)
{
	double nth_peak_amplitude;
	double train_position_of_nth_peak_amplitude,peak_position_original,amplitude_threshold, SNR;
	int train_counter;

	nth_peak_amplitude=nth_amplitude;
	peak_position_original=start_bin;
	train_position_of_nth_peak_amplitude=nth_position;

	SNR=noise_estim/mean_amplitude_trans;
	if (SNR<0.05)
		amplitude_threshold=noise_estim*3;
	else if (SNR<0.10)
		amplitude_threshold=noise_estim*1.5;
	else if (SNR<0.12)
		amplitude_threshold=noise_estim*1.3;
	else
		amplitude_threshold=noise_estim;

	for (train_counter=(int)start_bin+(int)(mean_width_transmitted/3.5);train_counter<=number_of_bins-1;train_counter++)
		{
			if 	((((amplitude[train_counter-1]<amplitude[train_counter])&&(amplitude[train_counter]>=amplitude[train_counter+1])/*peak*/
				&&(amplitude[train_counter]>=amplitude_threshold))
				&&((amplitude[train_counter]-amplitude[train_counter+2])>=2||((amplitude[train_counter]-amplitude[train_counter-2])>=2)
				||((amplitude[train_counter]==amplitude[train_counter+1])&&(amplitude[train_counter+1]==amplitude[train_counter+2])
				&&(amplitude[train_counter+2]>amplitude[train_counter+3]))
				||((amplitude[train_counter]==amplitude[train_counter+1])&&((amplitude[train_counter+1]>amplitude[train_counter+2])))))
				||
				((amplitude[train_counter-2]<amplitude[train_counter-1])&&(amplitude[train_counter-1]<amplitude[train_counter]) /*merged peak on leading edge - inflection point*/
				&&(amplitude[train_counter]<=amplitude[train_counter+1])&&(amplitude[train_counter+1]<amplitude[train_counter+2])&&(amplitude[train_counter]>=amplitude_threshold)
				&&((((amplitude[train_counter+1]-amplitude[train_counter])/(amplitude[train_counter]-amplitude[train_counter-1]))<=0.25)
				||(((amplitude[train_counter+1]-amplitude[train_counter])/(amplitude[train_counter+2]-amplitude[train_counter+1]))<=0.25)))
				||
				((amplitude[train_counter-2]>amplitude[train_counter-1])&&(amplitude[train_counter-1]>amplitude[train_counter])/*merged peak on trailing edge*/
				&&(amplitude[train_counter]>=amplitude[train_counter+1])&&(amplitude[train_counter+1]>=amplitude[train_counter+2])&&(amplitude[train_counter]>=amplitude_threshold)
				&&(((((amplitude[train_counter]-amplitude[train_counter+1])/(amplitude[train_counter-1]-amplitude[train_counter]))<=0.25)
				&&(amplitude[train_counter+1]>amplitude[train_counter+2]))
				||((((amplitude[train_counter]-amplitude[train_counter+1])/(amplitude[train_counter+1]-amplitude[train_counter+2]))<=0.25)
				&&(amplitude[train_counter-1]>amplitude[train_counter]))
				||((amplitude[train_counter]==amplitude[train_counter+1])&&(amplitude[train_counter+1]==amplitude[train_counter+2])
				&&(amplitude[train_counter+2]>=amplitude[train_counter+3])))))
					{
					nth_peak_amplitude=amplitude[train_counter];
					train_position_of_nth_peak_amplitude=train_counter;
					break;
					}
		}
		peak_position_original=train_position_of_nth_peak_amplitude;
		
		if ((nth_peak_amplitude==amplitude[train_counter+1])
			||((nth_peak_amplitude-amplitude[train_counter-1])/(nth_peak_amplitude-amplitude[train_counter+1])>2.7))
		{
			train_position_of_nth_peak_amplitude=(train_counter+0.5);
		}

		if ((nth_peak_amplitude==amplitude[train_counter+1])&&(nth_peak_amplitude==amplitude[train_counter+2]))
		{
			train_position_of_nth_peak_amplitude=(train_counter+1.0);
		}
			
		if ((nth_peak_amplitude==amplitude[train_counter+1])&&(nth_peak_amplitude==amplitude[train_counter+2])
			&&(nth_peak_amplitude==amplitude[train_counter+2]))
		{
			train_position_of_nth_peak_amplitude=(train_counter+1.5);
		}

		if (((nth_peak_amplitude-amplitude[train_counter-1])>0)
			&&((nth_peak_amplitude-amplitude[train_counter+1])/(nth_peak_amplitude-amplitude[train_counter-1])>2.7)
			&&(train_position_of_nth_peak_amplitude==train_counter))
		{
			train_position_of_nth_peak_amplitude=(train_counter-0.5);
		}

		if (nth_peak_amplitude>0)
		{
			*peak_position=train_position_of_nth_peak_amplitude;
		}
		else
		{
			*peak_position=start_bin-1;
		}

		*peak_amplitude=nth_peak_amplitude;
		*peak_position_orig_passon=peak_position_original;
	return(0);
}


void find_exact_width (double amplitude[],int number_of_bins,double train_position_of_nth_peak_amplitude,double nth_peak_amplitude,
	double *pulse_width_passon, double *train_half_amplitude_first_exact_passon, double *train_half_amplitude_last_exact_passon, 
	FILE *out_ptr2, double x,double y,double h, double mean_width_transmitted)
{

int train_half_amplitude_first, train_half_amplitude_last,half_amplitude_first_minus_one, half_amplitude_last_plus_one;
double half_amplitude_first, half_amplitude_last;
int train_counter;
double train_half_amplitude_first_exact, train_half_amplitude_last_exact;
double pulse_width;

				train_half_amplitude_first=-999;
				train_half_amplitude_last=0;
				half_amplitude_first=0;
				half_amplitude_first_minus_one=0;
				half_amplitude_last=0;
				half_amplitude_last_plus_one=0;
				for (train_counter=(int)(train_position_of_nth_peak_amplitude-mean_width_transmitted-1);train_counter<=(train_position_of_nth_peak_amplitude+mean_width_transmitted+1);train_counter++)
				{
					if ((amplitude[train_counter]>nth_peak_amplitude/2)&&(train_half_amplitude_first<0))
					{
						train_half_amplitude_first=train_counter;
						half_amplitude_first=amplitude[train_counter];
						half_amplitude_first_minus_one=(int)amplitude[train_counter-1];
					}
					if ((amplitude[train_counter]>nth_peak_amplitude/2)&&(amplitude[train_counter]>amplitude[train_counter+1]))
					{
						train_half_amplitude_last=train_counter;
						half_amplitude_last=amplitude[train_counter];
						half_amplitude_last_plus_one=(int)amplitude[train_counter+1];
					}
				}

				/* ONE PEAK - Find the exact times where the pulse crosses half of the maximum amplitude */
				train_half_amplitude_first_exact=(train_half_amplitude_first-1)
					+(((nth_peak_amplitude/2)-half_amplitude_first_minus_one)/(half_amplitude_first-half_amplitude_first_minus_one));
						
				if ((half_amplitude_first==half_amplitude_first_minus_one)&&(half_amplitude_first==nth_peak_amplitude/2))
				{
						train_half_amplitude_first_exact=train_half_amplitude_first;
				}

				train_half_amplitude_last_exact=(train_half_amplitude_last+1)
					-(((nth_peak_amplitude/2)-half_amplitude_last_plus_one)/(half_amplitude_last-half_amplitude_last_plus_one));
						
				if ((half_amplitude_last==half_amplitude_last_plus_one)&&(half_amplitude_last==nth_peak_amplitude/2))
				{
					train_half_amplitude_last_exact=train_half_amplitude_last;
				}
						
				/* ONE PEAK - check whether the crossing at half maximum is between X1 and X2 */
				if ((train_half_amplitude_first_exact>train_half_amplitude_first)
					||(train_half_amplitude_first_exact<(train_half_amplitude_first-1)))
				{
					train_half_amplitude_first_exact=0;
				}
				if ((train_half_amplitude_last_exact<train_half_amplitude_last)
					||(train_half_amplitude_last_exact>(train_half_amplitude_last+1))
					||(train_half_amplitude_last==0))
				{
					train_half_amplitude_last_exact=0;
				}

				/* ONE PEAK - Find the pulse width */
				if (((1+1.50*(fabs(train_half_amplitude_last_exact-train_position_of_nth_peak_amplitude))
					<(train_position_of_nth_peak_amplitude-train_half_amplitude_first_exact))
					||(train_half_amplitude_first_exact==0))
					||((1+1.50*(fabs(train_position_of_nth_peak_amplitude-train_half_amplitude_first_exact))
					<(train_half_amplitude_last_exact-train_position_of_nth_peak_amplitude))
					||(train_half_amplitude_last_exact==0)))
				{
					if ((1+1.50*(fabs(train_half_amplitude_last_exact-train_position_of_nth_peak_amplitude))
						<(train_position_of_nth_peak_amplitude-train_half_amplitude_first_exact))
						||(train_half_amplitude_first_exact==0))
					{
						pulse_width=2*(train_half_amplitude_last_exact-train_position_of_nth_peak_amplitude);
						if ((pulse_width<0)||(pulse_width<=mean_width_transmitted*0.8))
						{
							if (pulse_width<0)
							{
								//printf("Width not possible to calculate\n");
								pulse_width=0;
							}
							else
							{
								pulse_width=train_half_amplitude_last_exact-train_half_amplitude_first_exact;
								if (pulse_width>=1.2*mean_width_transmitted)
								{
									//printf("Width not possible to calculate\n");
									
								}
								else
								{
									//printf("Pulse width is %.2lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
								}
							}
						}
						else
						{
							if (pulse_width>=1.2*mean_width_transmitted)
							{
								//printf("Width too large\n");
								pulse_width=0;
							}
							else
							{
								train_half_amplitude_first_exact=train_position_of_nth_peak_amplitude-(pulse_width/2);
								//printf("Pulse width is %.2lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
							}
						}
					}
					else
					{
						pulse_width=2*(train_position_of_nth_peak_amplitude-train_half_amplitude_first_exact);
						if (pulse_width<mean_width_transmitted*0.6)
						{
							pulse_width=train_half_amplitude_last_exact-train_half_amplitude_first_exact;
							if (pulse_width<=0)
							{
								//printf("Width too small\n");
								pulse_width=0;
							}
							else
							{
								//printf("Pulse width is %.2lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
							}							
						}
						else
						{
							if (pulse_width>=1.2*mean_width_transmitted)
							{
								//printf("Width too large\n");
								pulse_width=0;
							}
							else
							{
								train_half_amplitude_last_exact=train_position_of_nth_peak_amplitude+(pulse_width/2);
								//printf("Joint peaks: pulse width approx(2xdistance) %.2lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
							}
						}
					}	
				}
				else
				{
					pulse_width=train_half_amplitude_last_exact-train_half_amplitude_first_exact;
					//printf("Pulse width is %.4lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
					//printf("\n");
				}
				*pulse_width_passon=pulse_width;
				*train_half_amplitude_first_exact_passon=train_half_amplitude_first_exact;
				*train_half_amplitude_last_exact_passon=train_half_amplitude_last_exact;

}


/************************************************************************************************************************************/
/*													P R O G R A M																	*/
/************************************************************************************************************************************/

main()
{
	/*****************/
	/* File pointers */
	/*****************/

	FILE *in_fp;
	FILE *out_len;
	FILE *out_xyz,*out_xyz_single;
	FILE *out_sum,*out_param;
	
	/*************/
	/* Variables */
	/*************/

	char in_filename[200];
    char out_file_param[200];
	char out_filename_xyz[200],out_filename_xyz1[200];
	char out_filename_sum[200],out_filename_len[200];

	double microseconds_since_midnight;
	double amplitude[5001];

	int train_counter;
	int pulse_counter;
	int count_ringing,count_noise,total_number_of_points;
	int waveform_broken, waveform_disregarded, waveform_one_peak,waveform_two_peaks,waveform_three_peaks,waveform_four_peaks,waveform_five_peaks, waveform_six_peaks;
	double first_peak_amplitude,second_peak_amplitude,third_peak_amplitude, fourth_peak_amplitude,fifth_peak_amplitude, sixth_peak_amplitude,ringing_peak_amplitude/* , odd_amplitude */ ;
	double half_amplitude_first, half_amplitude_last, train_half_amplitude_first_exact, train_half_amplitude_last_exact, pulse_width;
	double train_position_of_first_peak_amplitude,train_position_of_second_peak_amplitude,train_position_of_third_peak_amplitude,train_position_of_fourth_peak_amplitude;
	double train_position_of_fifth_peak_amplitude,train_position_of_sixth_peak_amplitude,train_position_of_ringing_peak_amplitude;
	double first_peak_position_original,second_peak_position_original,third_peak_position_original,fourth_peak_position_original,fifth_peak_position_original,sixth_peak_position_original;
	int train_half_amplitude_first, train_half_amplitude_last, half_amplitude_first_minus_one, half_amplitude_last_plus_one;
	double sum_amplitude_ringing, mean_amplitude_ringing; 

	/* New variables for 2011 version of data */

	double gps_time; /* Seconds, so microseconds is this *1e6 */
	double start_pulse_easting, start_pulse_northing,x1,x2,x3,x4,y1,y2,y3,y4,h1,h2,h3,h4,x5,y5,h5,x6,y6,h6;
	double start_pulse_elevation,waveform_vector_easting, waveform_vector_northing, waveform_vector_elevation,outgoing_peak_amplitude,train_position_of_outgoing_peak_amplitude;
	
	double waveform_start_easting, waveform_start_northing, waveform_start_elevation;//allowing ten segments in waveform sampling
	double start_pulse_waveform[100];
	int first_sample_offset;
	double peak_elev;
	int number_of_bins; /* How many 1ns bins are in the data */
	char identifier[25], input_file_param[2];
	double incidence_angle;
	int pulseID,Sampling_unit,Pulse_descriptor,transmitted_samples,TotalNoOfSegments,segment;
	int SegmentNo;//allowing ten segments in waveform sampling
	double mean_width_transmitted,sum_width_transmitted,noise_estim, noise_estim_single;
	int disregard;
	double mean_vector_elevation, sum_vector_elevation;

	double sum_single_width,sum_single_amplitude, mean_single_amplitude,mean_single_width;

	double	max_trans_ampl, max_rec_ampl;
	double sum_amplitude_trans, mean_amplitude_trans;
	int count_amplitude_trans;

	double noise_sum_rec=0;
	int count_noise_rec=0;



	/*****************/
	/* P R O G R A M */
	/*****************/

	waveform_broken=0;
	waveform_disregarded=0;
	waveform_one_peak=0;
	waveform_two_peaks=0;
	waveform_three_peaks=0;
	waveform_four_peaks=0;
	waveform_five_peaks=0;
	waveform_six_peaks=0;
	sum_amplitude_ringing=0; 
	mean_amplitude_ringing=0;
	noise_estim=0;

	printf("***********************************************************************\n");
	printf("**               Module 2 of Canopy Height Program                   **\n");
	printf("***********************************************************************\n");
	printf("** Reads data from .txt file generated by Module 1 and processes to  **\n");
	printf("** extract pulse location, amplitude and width.                      **\n");
	printf("**                                                                   **\n");
	printf("** Authors: Karolina Fieber, Ian Davenport                           **\n");
	printf("** k.fieber@reading.ac.uk, i.j.davenport@reading.ac.uk               **\n");
	printf("** University of Reading, UK                              March 2015 **\n");
	printf("***********************************************************************\n\n");

	printf("Enter the name of the input file (without '_fulwvs' suffix): ");
	scanf("%s",&identifier);

	sprintf(in_filename,"%s_fulwvs.txt",identifier);
	printf("\n\tReading from file <<%s>>\n",in_filename);
	in_fp=fopen(in_filename,"r");
	if (!in_fp)
	{
		printf("Can't open input data file <%s>\n",in_filename);
 		return(-1);
	}
	
	sprintf(out_filename_sum,"%s_info_Module2.txt",identifier);
	out_sum=fopen(out_filename_sum,"w");
	if (!out_sum)
	{
		printf("Can't open output data file <%s>\n",out_filename_sum);
 		return(-1);
	}
	fprintf(out_sum,"***********************************************************************\n");
	fprintf(out_sum,"**               Module 2 of Canopy Height Program                   **\n");
	fprintf(out_sum,"***********************************************************************\n");
	fprintf(out_sum,"** Reads data from .txt file generated by Module 1 and processes to  **\n");
	fprintf(out_sum,"** extract pulse location, amplitude and width.                      **\n");
	fprintf(out_sum,"**                                                                   **\n");
	fprintf(out_sum,"** Authors: Karolina Fieber, Ian Davenport                           **\n");
	fprintf(out_sum,"** k.fieber@reading.ac.uk, i.j.davenport@reading.ac.uk               **\n");
	fprintf(out_sum,"** University of Reading, UK                              March 2015 **\n");
	fprintf(out_sum,"***********************************************************************\n\n");
	fprintf(out_sum,"\tReading from file <<%s>>\n",in_filename);
	
	// OPEN file
	
	sprintf(out_file_param,"%s_received_param.txt",identifier);
	out_param=fopen(out_file_param,"w");
	if (!out_param)
	{
		printf("Can't open output data file <%s>\n",out_file_param);
 		return(-1);
	}
	fprintf(out_sum,"\n\tWriting to file <<%s>>\n",out_file_param);
	
	sprintf(out_filename_xyz,"%s_XYZ.txt",identifier);
	out_xyz=fopen(out_filename_xyz,"w");
	if (!out_xyz)
	{
		printf("Can't open output data file <%s>\n",out_filename_xyz);
 		return(-1);
	}
	fprintf(out_sum,"\tWriting to file <<%s>>\n",out_filename_xyz);

	sprintf(out_filename_xyz1,"%s_XYZ_single.txt",identifier);
	out_xyz_single=fopen(out_filename_xyz1,"w");
	if (!out_xyz_single)
	{
		printf("Can't open output data file <%s>\n",out_filename_xyz1);
 		return(-1);
	}
	fprintf(out_sum,"\tWriting to file <<%s>>\n",out_filename_xyz1);

	sprintf(out_filename_len,"%s_param.txt",identifier);
	out_len=fopen(out_filename_len,"w");
	if (!out_len)
	{
		printf("Can't open output data file <%s>\n",out_filename_len);
 		return(-1);
	}
	fprintf(out_sum,"\tWriting to file <<%s>>\n",out_filename_len);

	//////////////////////////////////////////////////////////////////
	// Process transmitted waveforms - pulse width, location, ringing
	///////////////////////////////////////////////////////////////////
	printf("\n***********************************************************************");
	printf("\n***********  Starting to process transmitted waveforms  ***************");
	printf("\n***********************************************************************");

	fprintf(out_sum,"\n***********************************************************************");
	fprintf(out_sum,"\n***********  Starting to process transmitted waveforms  ***************");
	fprintf(out_sum,"\n***********************************************************************");
	pulse_counter=0;
	count_ringing=0;
	sum_width_transmitted=0;
	mean_width_transmitted=0;
	sum_single_amplitude=0;
	sum_single_width=0;
	count_noise=0;
	sum_amplitude_trans=0;
	count_amplitude_trans=0;
	mean_amplitude_trans=0;
	max_rec_ampl=0;
	do
	{
		pulse_counter++;
		//printf("%d: ",pulse_counter);
		max_trans_ampl=0;

		noise_estim_single=0;
		/****************/
		/* Read in data */
		/****************/
		pulseID=readininteger(in_fp); //pulseID
		gps_time=readindouble(in_fp); //GPS time
		if (gps_time!=-999)
		{
			Sampling_unit=readininteger(in_fp);					// Sampling unit eg. 1ns
			Pulse_descriptor=readininteger(in_fp);				// Pulse descriptor in the original file
			start_pulse_easting=readindouble(in_fp);			// anchor location easting
			start_pulse_northing=readindouble(in_fp);			// anchor location northing
			start_pulse_elevation=readindouble(in_fp);			// anchor location elevation
			transmitted_samples=readininteger(in_fp);			// number of samples in transmitted waveform
			for (train_counter=0;train_counter<=transmitted_samples-1;train_counter++)
			{
				start_pulse_waveform[train_counter]=readindouble(in_fp);
				if (start_pulse_waveform[train_counter]>max_trans_ampl)// to fine maximum amplitude value to be able to determine a threshold for peak search
				{
					max_trans_ampl=start_pulse_waveform[train_counter];
				}
				if (train_counter>=transmitted_samples-2) // to estimated the noise based on last two samples of transmitted waveform
				{
					noise_estim_single=noise_estim_single+start_pulse_waveform[train_counter];
					noise_estim=noise_estim+start_pulse_waveform[train_counter];
					count_noise++;
				}
			}
				
			noise_estim_single=noise_estim_single/2;

			waveform_vector_easting=readindouble(in_fp);		// vector easting
			waveform_vector_northing=readindouble(in_fp);		// vector northing
			waveform_vector_elevation=readindouble(in_fp);		// vector elevation
			TotalNoOfSegments=readininteger(in_fp);				// number of segments of received waveform

			for (segment=1;segment<=TotalNoOfSegments;segment++)
			{
				SegmentNo=readininteger(in_fp);				//segment number
				first_sample_offset=readininteger(in_fp);		//offset to the first sample of that segment

				waveform_start_easting=readindouble(in_fp);	//easting coordinate of the first sample in the segment
				waveform_start_northing=readindouble(in_fp);	//northing coordinate of the first sample in the segment
				waveform_start_elevation=readindouble(in_fp);	//elevation coordinate of the first sample in the segment
				number_of_bins=readininteger(in_fp);					//number of samples in received waveform (particular segment)
				for (train_counter=0;train_counter<=number_of_bins-1;train_counter++)
				{
					amplitude[train_counter]=readindouble(in_fp);
					if (amplitude[train_counter]>max_rec_ampl)
					{
						max_rec_ampl=amplitude[train_counter];
					}

					if (train_counter==number_of_bins-1)
					{
						noise_sum_rec=noise_sum_rec+amplitude[train_counter];
						count_noise_rec++;
					}
				}
				
				peak_elev=readindouble(in_fp);					// elevation of the bin with the highest amplitude
			}

			microseconds_since_midnight=gps_time*1e6;
		
		
/********************************************************************************************************************************************************/
			/*************************/
			/* Get the outgoing peak */
			/*************************/
			if (transmitted_samples!=0)
			{
				// TRANSMITTED WAVEFORM PEAK POSITION and AMPLITUDE
				outgoing_peak_amplitude=0;
				train_position_of_outgoing_peak_amplitude=1;
				for (train_counter=0;train_counter<=transmitted_samples-1;train_counter++)
				{
					if 	(((start_pulse_waveform[train_counter-1]<start_pulse_waveform[train_counter])&&(start_pulse_waveform[train_counter]>=start_pulse_waveform[train_counter+1])
						&&(start_pulse_waveform[train_counter]>(max_trans_ampl/1.5)))&&
						((start_pulse_waveform[train_counter]-start_pulse_waveform[train_counter+2]>=max_trans_ampl/20)||(start_pulse_waveform[train_counter]-start_pulse_waveform[train_counter-2]>=max_trans_ampl/20)))

						{
							outgoing_peak_amplitude=start_pulse_waveform[train_counter];
							train_position_of_outgoing_peak_amplitude=train_counter;
							sum_amplitude_trans=sum_amplitude_trans+outgoing_peak_amplitude;
							count_amplitude_trans++;
							break;
						}
				}
	
				//refine the position of the peak depending on amplitude of consecutive bins
				if ((outgoing_peak_amplitude==start_pulse_waveform[train_counter+1])
					||((outgoing_peak_amplitude-start_pulse_waveform[train_counter-1])/(outgoing_peak_amplitude-start_pulse_waveform[train_counter+1])>2.7))
				{
					train_position_of_outgoing_peak_amplitude=(train_counter+0.5);
				}

				if ((outgoing_peak_amplitude==start_pulse_waveform[train_counter+1])&&(outgoing_peak_amplitude==start_pulse_waveform[train_counter+2]))
				{
					train_position_of_outgoing_peak_amplitude=(train_counter+1.0);
				}
			
				if ((outgoing_peak_amplitude==start_pulse_waveform[train_counter+1])&&(outgoing_peak_amplitude==start_pulse_waveform[train_counter+2])
					&&(outgoing_peak_amplitude==start_pulse_waveform[train_counter+2]))
				{
					train_position_of_outgoing_peak_amplitude=(train_counter+1.5);
				}

				if (((outgoing_peak_amplitude-start_pulse_waveform[train_counter-1])>0)
					&&((outgoing_peak_amplitude-start_pulse_waveform[train_counter+1])/(outgoing_peak_amplitude-start_pulse_waveform[train_counter-1])>2.7))
				{
					train_position_of_outgoing_peak_amplitude=(train_counter-0.5);
				}

				if (((outgoing_peak_amplitude-start_pulse_waveform[train_counter-1])>0)
					&&((outgoing_peak_amplitude-start_pulse_waveform[train_counter+1])/(outgoing_peak_amplitude-start_pulse_waveform[train_counter-1])<=2.7))
	
				{
					train_position_of_outgoing_peak_amplitude=train_counter;
				}
				//fprintf(out_outgoing,"%d,1,%.0lf,%.0lf,", pulseID,train_position_of_outgoing_peak_amplitude,outgoing_peak_amplitude);
				//fprintf(out_outgoing2,"1,%.0lf,%.0lf,",train_position_of_outgoing_peak_amplitude,outgoing_peak_amplitude);
		
				/* GET THE RINGING PULSE*/
				ringing_peak_amplitude=0;
				train_position_of_ringing_peak_amplitude=0;
				for (train_counter=(int)train_position_of_outgoing_peak_amplitude+2;train_counter<=transmitted_samples-1;train_counter++)
				{
					if 	((start_pulse_waveform[train_counter-1]<start_pulse_waveform[train_counter])
						&&(start_pulse_waveform[train_counter]>=start_pulse_waveform[train_counter+1])
						&&(start_pulse_waveform[train_counter]>=(max_trans_ampl/25))
						&&(start_pulse_waveform[train_counter]>=(noise_estim_single*0.9))&&
						((start_pulse_waveform[train_counter]-start_pulse_waveform[train_counter+2]>=(noise_estim_single/2))||(start_pulse_waveform[train_counter]-start_pulse_waveform[train_counter-2]>=(noise_estim_single/2))))

						{
							ringing_peak_amplitude=start_pulse_waveform[train_counter];
							train_position_of_ringing_peak_amplitude=train_counter;
							break;
						}
				}
				if ((ringing_peak_amplitude==start_pulse_waveform[train_counter+1])
					||(((ringing_peak_amplitude-start_pulse_waveform[train_counter+1]<=6)&&(ringing_peak_amplitude>=150)&&(ringing_peak_amplitude-start_pulse_waveform[train_counter-1]>15))
					||((ringing_peak_amplitude-start_pulse_waveform[train_counter+1]<=15)&&(ringing_peak_amplitude>=350)&&(ringing_peak_amplitude-start_pulse_waveform[train_counter-1]>30))))
				{
					train_position_of_ringing_peak_amplitude=(train_counter+0.5);
				}
		
				// WIDTH OF TRANSMITTED PULSE //
				/* ONE PEAK - Find locations where signal rises to and drops past half of peak amplitude */
				train_half_amplitude_first=-999;
				train_half_amplitude_last=0;
				half_amplitude_first=0;
				half_amplitude_first_minus_one=0;
				half_amplitude_last=0;
				half_amplitude_last_plus_one=0;
	
				for (train_counter=(int)(train_position_of_outgoing_peak_amplitude-(transmitted_samples/4));train_counter<=(train_position_of_outgoing_peak_amplitude+transmitted_samples/4);train_counter++)
				{
					if ((start_pulse_waveform[train_counter]>(noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2))&&(train_half_amplitude_first<0))
					{
						train_half_amplitude_first=train_counter;
						half_amplitude_first=start_pulse_waveform[train_counter];
						half_amplitude_first_minus_one=(int)start_pulse_waveform[train_counter-1];
					}
					if ((start_pulse_waveform[train_counter]>(noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2))&&(start_pulse_waveform[train_counter]>start_pulse_waveform[train_counter+1]))
					{
						train_half_amplitude_last=train_counter;
						half_amplitude_last=start_pulse_waveform[train_counter];
						half_amplitude_last_plus_one=(int)start_pulse_waveform[train_counter+1];
					}
				}

				/* ONE PEAK - Find the exact times where the pulse crosses half of the maximum amplitude */
				train_half_amplitude_first_exact=(train_half_amplitude_first-1)
					+(((noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2)-half_amplitude_first_minus_one)/(half_amplitude_first-half_amplitude_first_minus_one));
						
				if ((half_amplitude_first==half_amplitude_first_minus_one)&&(half_amplitude_first==(noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2)))
				{
						train_half_amplitude_first_exact=train_half_amplitude_first;
				}

				train_half_amplitude_last_exact=(train_half_amplitude_last+1)
					-(((noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2)-half_amplitude_last_plus_one)/(half_amplitude_last-half_amplitude_last_plus_one));
						
				if ((half_amplitude_last==half_amplitude_last_plus_one)&&(half_amplitude_last==(noise_estim_single+(outgoing_peak_amplitude-noise_estim_single)/2)))
				{
					train_half_amplitude_last_exact=train_half_amplitude_last;
				}
						
				/* ONE PEAK - check whether the crossing at half maximum is between X1 and X2 */
				if ((train_half_amplitude_first_exact>train_half_amplitude_first)
					||(train_half_amplitude_first_exact<(train_half_amplitude_first-1)))
				{
					train_half_amplitude_first_exact=0;
				}
				if ((train_half_amplitude_last_exact<train_half_amplitude_last)
					||(train_half_amplitude_last_exact>(train_half_amplitude_last+1))
					||(train_half_amplitude_last==0))
				{
					train_half_amplitude_last_exact=0;
				}

				/*Pulse width*/
				{
					pulse_width=train_half_amplitude_last_exact-train_half_amplitude_first_exact;
					//printf("Pulse width is %.4lfns between %.2lf and %.2lf\n",pulse_width,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
					//fprintf(out_outgoing,"%.4lf,%.2lf and %.2lf,",pulse_width/2.35482,train_half_amplitude_first_exact,train_half_amplitude_last_exact);
					//fprintf(out_outgoing2,"%.4lf\n",pulse_width/2.35482);
					sum_width_transmitted=sum_width_transmitted+pulse_width;
					//fprintf(out_outgoing,"%.0lf,%.0lf,%lf",train_position_of_ringing_peak_amplitude,ringing_peak_amplitude,(ringing_peak_amplitude/outgoing_peak_amplitude));
					
					if (train_position_of_ringing_peak_amplitude!=0)
					{
						//fprintf(out_outgoing,",%.1lf\n", (train_position_of_ringing_peak_amplitude-train_position_of_outgoing_peak_amplitude));
						count_ringing++;
						sum_amplitude_ringing+=(ringing_peak_amplitude/outgoing_peak_amplitude);
						mean_amplitude_ringing=sum_amplitude_ringing/count_ringing;
					}
					else
					{
					//fprintf(out_outgoing,"\n");
					}
					//printf("\n");
				}
			}
		}
	}
	while (!feof(in_fp));

	if (transmitted_samples==0)
	 // if there is no transmitted waveform recorded specify ringing peak ratio.
	{
		printf("\n\n\tYour dataset does not contain transmitted waveform.\n\n");

		fprintf(out_sum,"\n\n\tYour dataset does not contain transmitted waveform.\n"); // Only identify extent, no extractions; Set it to Y/y if you only need the program to generate the extents list*/
		

		printf("\nPlease specify amplitude of transmitted pulse [DN]\n\t (maximum amplitude in received waveforms %.2f):  ",max_rec_ampl);
		scanf("%lf",&mean_amplitude_trans);
		while (mean_amplitude_trans<1)
		{
				printf("\n WRONG INPUT: Specify value > 1: ");
				scanf("%lf",&mean_amplitude_trans);
		}
		fprintf(out_sum,"\nPlease specify amplitude of transmitted pulse [DN]\n\t (maximum amplitude in received waveforms %.2f): %lf",max_rec_ampl,mean_amplitude_trans);
		
		count_amplitude_trans=1;
		sum_amplitude_trans=mean_amplitude_trans;

		printf("\nPlease specify width of transmitted pulse [ns]\n\t Riegl usually 4ns\n\t ALS can differ 4-9ns:  ");
		scanf("%lf",&mean_width_transmitted);
		while (mean_width_transmitted<1)
		{
				printf("\n WRONG INPUT: Specify value > 1: ");
				scanf("%lf",&mean_width_transmitted);
		}
		fprintf(out_sum,"\nPlease specify width of transmitted pulse [ns]: %lf",mean_width_transmitted);


		printf("\nPlease specify mean noise within the data \n\t(suggested at least %.2f):  ",noise_sum_rec/count_noise_rec);
		scanf("%lf",&noise_estim);
		while (noise_estim<0)
		{
				printf("\n WRONG INPUT: Specify value >= 0: ");
				scanf("%lf",&noise_estim);
		}
		fprintf(out_sum,"\nPlease specify mean noise within the data: %lf",noise_estim);
		
		mean_amplitude_ringing=noise_estim/mean_amplitude_trans;

		printf("\nPlease specify ringing ratio for removal of ringing echoes \n\t(suggested value above: %.3lf):  ",mean_amplitude_ringing);
		scanf("%lf",&mean_amplitude_ringing);
		while (mean_amplitude_ringing>1)
		{
				printf("\n WRONG INPUT: Specify value < 1: ");
				scanf("%lf",&mean_amplitude_ringing);
		}
		fprintf(out_sum,"\nPlease specify ringing ratio for removal of ringing echoes: %lf",mean_amplitude_ringing);
		
		count_noise=1;
	}
	else
	{
		noise_estim=noise_estim/count_noise;
		mean_amplitude_trans=sum_amplitude_trans/count_amplitude_trans;

		if (mean_width_transmitted==0)
		{
			mean_width_transmitted=sum_width_transmitted/pulse_counter;
		}

		printf("\n\nPARAMETERS found:");
		printf("\n* Mean amplitude of transmitted pulse: %.2lf *",mean_amplitude_trans);
		printf("\n* Mean width of transmitted pulse: %.2lf *",mean_width_transmitted);
		printf("\n* Mean noise in transmitted waveform: %lf *",noise_estim);
		printf("\n* Mean ringing ratio: %lf *",mean_amplitude_ringing);

		fprintf(out_sum,"\n\nPARAMETERS found:");
		fprintf(out_sum,"\n* Mean amplitude of transmitted pulse: %.2lf *",mean_amplitude_trans);
		fprintf(out_sum,"\n* Mean width of transmitted pulse: %.2lf *",mean_width_transmitted);
		fprintf(out_sum,"\n* Mean noise in transmitted waveform: %lf *",noise_estim);
		fprintf(out_sum,"\n* Mean ringing ratio: %lf *",mean_amplitude_ringing);

		printf("\n\nDo you want to change the mean noise value or mean ringing ratio (Y/N)? ");
		scanf("%s",&input_file_param);
		while ((input_file_param[0]!='Y'&&input_file_param[0]!='y')&&(input_file_param[0]!='N'&&input_file_param[0]!='n'))
		{
			printf("\nWRONG INPUT: Y/N? ");
			scanf("%s",&input_file_param);
		}
		fprintf(out_sum,"\n\nDo you want to change the mean noise value or mean ringing ratio? %s", input_file_param);

		if (input_file_param[0]!='N'&&input_file_param[0]!='n')
		{
			printf("\n\tProvide a new noise estimate: ");
			scanf("%lf",&noise_estim);
			while (noise_estim<0)
			{
					printf("\n\tWRONG INPUT: Specify value >= 0: ");
					scanf("%lf",&noise_estim);
			}
			fprintf(out_sum,"\n\tProvide a new noise estimate: %lf", noise_estim);
			
			mean_amplitude_ringing=noise_estim/mean_amplitude_trans;

			printf("\n\tProvide a new ringing estimate \n\t(suggested larger than %lf): ",mean_amplitude_ringing);
			scanf("%lf",&mean_amplitude_ringing);
			while (mean_amplitude_ringing>1)
			{
					printf("\n\tWRONG INPUT: Specify value < 1: ");
					scanf("%lf",&mean_amplitude_ringing);
			}
			fprintf(out_sum,"\n\tProvide a new ringing estimate: %lf", mean_amplitude_ringing);
		}
	}

	printf("\n\n\tProcessing of transmitted waveforms is finished");
	fprintf(out_sum,"\n\n\tProcessing of transmitted waveforms is finished");

	////////////////////////////////////////////////////////////////
	// Processing of receive waveforms
	////////////////////////////////////////////////////////////
	rewind(in_fp);

	printf("\n\n***********************************************************************");
	printf("\n**************  Starting to process received waveforms  ***************");
	printf("\n***********************************************************************");

	fprintf(out_sum,"\n\n***********************************************************************");
	fprintf(out_sum,"\n**************  Starting to process received waveforms  ***************");
	fprintf(out_sum,"\n***********************************************************************");

	pulse_counter=0;
	sum_vector_elevation=0;

	do
	{
		pulse_counter++;
		
		/****************/
		/* Read in data */
		/****************/

		pulseID=readininteger(in_fp); //pulseID
		gps_time=readindouble(in_fp); //GPS time
		if (gps_time!=-999)
		{
			Sampling_unit=readininteger(in_fp);					// Sampling unit eg. 1ns
			Pulse_descriptor=readininteger(in_fp);				// Pulse descriptor in the original file
			start_pulse_easting=readindouble(in_fp);			// anchor location easting
			start_pulse_northing=readindouble(in_fp);			// anchor location northing
			start_pulse_elevation=readindouble(in_fp);			// anchor location elevation
			transmitted_samples=readininteger(in_fp);			// number of samples in transmitted waveform
			for (train_counter=0;train_counter<=transmitted_samples-1;train_counter++)
				start_pulse_waveform[train_counter]=readindouble(in_fp);
			
			
			waveform_vector_easting=readindouble(in_fp);		// vector easting
			waveform_vector_northing=readindouble(in_fp);		// vector northing
			waveform_vector_elevation=readindouble(in_fp);		// vector elevation

			sum_vector_elevation=sum_vector_elevation+waveform_vector_elevation;

			TotalNoOfSegments=readininteger(in_fp);				// number of segments of received waveform

			for (segment=1;segment<=TotalNoOfSegments;segment++)
			{
				SegmentNo=readininteger(in_fp);				//segment number
				first_sample_offset=readininteger(in_fp);		//offset to the first sample of that segment

				waveform_start_easting=readindouble(in_fp);	//easting coordinate of the first sample in the segment
				waveform_start_northing=readindouble(in_fp);	//northing coordinate of the first sample in the segment
				waveform_start_elevation=readindouble(in_fp);	//elevation coordinate of the first sample in the segment
				number_of_bins=readininteger(in_fp);					//number of samples in received waveform (particular segment)
				for (train_counter=0;train_counter<=number_of_bins-1;train_counter++)
					amplitude[train_counter]=readindouble(in_fp);
				peak_elev=readindouble(in_fp);					// elevation of the bin with the highest amplitude
			

				microseconds_since_midnight=gps_time*1e6;
		
				incidence_angle=0;
				incidence_angle=(acos(-waveform_vector_elevation/sqrt(pow(waveform_vector_easting,2)+pow(waveform_vector_northing,2)+pow(waveform_vector_elevation,2))))*180/3.141592653;

	/*******************************************************************************************************************************************************/



				disregard=0;

				/**********************/
				/* Get the first peak */
				/**********************/

				find_first_peak(amplitude,number_of_bins,1,&first_peak_position_original,&train_position_of_first_peak_amplitude,&first_peak_amplitude,noise_estim,mean_amplitude_trans); 

				//printf("\n******************************************************\n");
				//printf("Waveform number %d\n",pulseID);

				if (train_position_of_first_peak_amplitude==0)
				{
					disregard=1;
				}

				//printf("The first peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_first_peak_amplitude, first_peak_amplitude);

				x1=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_first_peak_amplitude);
				y1=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_first_peak_amplitude);
				h1=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_first_peak_amplitude);

				/**********************/
				/* Get the second peak*/
				/**********************/

				find_nth_peak(amplitude,number_of_bins,first_peak_position_original,train_position_of_first_peak_amplitude,first_peak_amplitude, &second_peak_position_original, &train_position_of_second_peak_amplitude, &second_peak_amplitude,noise_estim,mean_width_transmitted,mean_amplitude_trans);

				if (train_position_of_second_peak_amplitude>=number_of_bins)
				{
					train_position_of_second_peak_amplitude=train_position_of_first_peak_amplitude;
					second_peak_amplitude=first_peak_amplitude;
				}
				//printf("The second peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_second_peak_amplitude,second_peak_amplitude);
			
				x2=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_second_peak_amplitude);
				y2=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_second_peak_amplitude);
				h2=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_second_peak_amplitude);

				/**********************/
				/* Get the third peak */
				/**********************/

				find_nth_peak(amplitude,number_of_bins,second_peak_position_original,train_position_of_second_peak_amplitude,second_peak_amplitude,&third_peak_position_original, &train_position_of_third_peak_amplitude, &third_peak_amplitude,noise_estim,mean_width_transmitted,mean_amplitude_trans);

				if (train_position_of_third_peak_amplitude>=number_of_bins)
				{
					train_position_of_third_peak_amplitude=train_position_of_second_peak_amplitude;
					third_peak_amplitude=second_peak_amplitude;
				}

				//printf("The third peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_third_peak_amplitude,third_peak_amplitude);

				x3=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_third_peak_amplitude);
				y3=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_third_peak_amplitude);
				h3=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_third_peak_amplitude);

				/**********************/
				/* Get the fourth peak */
				/**********************/

				find_nth_peak(amplitude,number_of_bins,third_peak_position_original,train_position_of_third_peak_amplitude,third_peak_amplitude,&fourth_peak_position_original,&train_position_of_fourth_peak_amplitude,&fourth_peak_amplitude,noise_estim,mean_width_transmitted,mean_amplitude_trans);

				if (train_position_of_fourth_peak_amplitude>=number_of_bins)
				{
					train_position_of_fourth_peak_amplitude=train_position_of_third_peak_amplitude;
					fourth_peak_amplitude=third_peak_amplitude;
				}

				//printf("The fourth peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_fourth_peak_amplitude,fourth_peak_amplitude);

				x4=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_fourth_peak_amplitude);
				y4=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_fourth_peak_amplitude);
				h4=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_fourth_peak_amplitude);

				/**********************/
				/* Get the fifth peak */
				/**********************/

				find_nth_peak(amplitude,number_of_bins,fourth_peak_position_original,train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,&fifth_peak_position_original,&train_position_of_fifth_peak_amplitude,&fifth_peak_amplitude,noise_estim,mean_width_transmitted,mean_amplitude_trans);

				if (train_position_of_fifth_peak_amplitude>=number_of_bins)
				{
					train_position_of_fifth_peak_amplitude=train_position_of_fourth_peak_amplitude;
					fifth_peak_amplitude=fourth_peak_amplitude;
				}

				//printf("The fifth peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_fifth_peak_amplitude,fifth_peak_amplitude);

				x5=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_fifth_peak_amplitude);
				y5=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_fifth_peak_amplitude);
				h5=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_fifth_peak_amplitude);

				/**********************/
				/* Get the sixth peak */
				/**********************/

				find_nth_peak(amplitude,number_of_bins,fifth_peak_position_original,train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,&sixth_peak_position_original,&train_position_of_sixth_peak_amplitude,&sixth_peak_amplitude,noise_estim,mean_width_transmitted,mean_amplitude_trans);

				if (train_position_of_sixth_peak_amplitude>=number_of_bins)
				{
					train_position_of_sixth_peak_amplitude=train_position_of_fifth_peak_amplitude;
					sixth_peak_amplitude=fifth_peak_amplitude;
				}

				//printf("The sixth peak is at %.1lf ns and its amplitude is %.2lf\n",train_position_of_sixth_peak_amplitude,sixth_peak_amplitude);

				x6=start_pulse_easting+waveform_vector_easting*(first_sample_offset+train_position_of_sixth_peak_amplitude);
				y6=start_pulse_northing+waveform_vector_northing*(first_sample_offset+train_position_of_sixth_peak_amplitude);
				h6=start_pulse_elevation+waveform_vector_elevation*(first_sample_offset+train_position_of_sixth_peak_amplitude);

		/***********************************************************************************************************************************************/	
				/*******************************/
				/* Calculate mean noise and standard deviation of the noise*/
				/*******************************/

		
	/******************************************************************************************************************************************************************/

				/*******************************************************************************/
				/* Disregard waveforms whose first peak falls on the first 4 ns or the last ns */
				/*******************************************************************************/

				if (((train_position_of_first_peak_amplitude<6)&&(train_position_of_first_peak_amplitude==train_position_of_second_peak_amplitude))||(train_position_of_first_peak_amplitude>=(number_of_bins-2))
					||(((train_position_of_first_peak_amplitude==train_position_of_second_peak_amplitude)
						&&(train_position_of_second_peak_amplitude==train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude==train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude==train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude)))
						&&(first_peak_amplitude<=noise_estim*1.1)|| disregard==1)
		
				{
					waveform_disregarded++;
					fprintf(out_param,"-999\n");
				}

				/********************************************/	
				/* Count the peaks and calculate their FWHM */
				/********************************************/
			
				else
				{
					// write to revised file

					if ((train_position_of_first_peak_amplitude==train_position_of_second_peak_amplitude)		/* ONE-PEAK WAVEFORM */
						&&(train_position_of_second_peak_amplitude==train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude==train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude==train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude))
					{
						waveform_one_peak++;
				
						/*SINGLE*/
						fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID, first_peak_amplitude);
						fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);
						find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
							&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
						if ((pulse_width<=0.8*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
						{
							fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
							fprintf(out_xyz_single,",%lf,%lf,%lf",x1,y1,h1);
							fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
						}
						else
						{
							fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
							fprintf(out_xyz_single,"%lf,%lf,%lf,%lf",pulse_width,x1,y1,h1);
							fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
						}
						sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
						sum_single_width=sum_single_width+pulse_width;
						fprintf(out_xyz,"%lf\n",incidence_angle);
						fprintf(out_xyz_single,"\n");
					}
		
					if ((train_position_of_first_peak_amplitude!=train_position_of_second_peak_amplitude)
						&&(train_position_of_second_peak_amplitude==train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude==train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude==train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude))
					{	/* ONE-PEAK WAVEFORM */
						if ((train_position_of_second_peak_amplitude>=(number_of_bins-0.5))							
							||
							((second_peak_amplitude/first_peak_amplitude)<=3.1*mean_amplitude_ringing
							&&(train_position_of_second_peak_amplitude<=(train_position_of_first_peak_amplitude+20))
							&&(train_position_of_second_peak_amplitude>=(train_position_of_first_peak_amplitude+3)))
							||
							((second_peak_amplitude/first_peak_amplitude)<=1.1*mean_amplitude_ringing))
						{
							waveform_one_peak++;

							/*SINGLE*/
							fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID, first_peak_amplitude);
							fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
							if ((pulse_width<=0.8*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_xyz_single,",%lf,%lf,%lf",x1,y1,h1);
								fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
								fprintf(out_xyz_single,"%lf,%lf,%lf,%lf",pulse_width,x1,y1,h1);
								fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
							sum_single_width=sum_single_width+pulse_width;
							fprintf(out_xyz,"%lf\n",incidence_angle);
							fprintf(out_xyz_single,"\n");	
						}
						else			/* TWO-PEAK WAVEFORM */
						{
							waveform_two_peaks++;
					
							/*FIRST*/
							fprintf(out_xyz,"%d,1,2,%.0lf,",pulseID, first_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
							if ((pulse_width<=0.8*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
							fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
							fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

							/*SECOND*/

							fprintf(out_xyz,"%d,2,2,%.0lf,",pulseID,second_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
							if ((pulse_width<=0.8*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/3))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

						}
					}
				
					if ((train_position_of_first_peak_amplitude!=train_position_of_second_peak_amplitude)
						&&(train_position_of_second_peak_amplitude!=train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude==train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude==train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude))
					{
						if (((train_position_of_third_peak_amplitude>=(number_of_bins-0.5))				/* TWO-PEAK WAVEFORM */
							||((third_peak_amplitude/second_peak_amplitude)<=3.2*mean_amplitude_ringing
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+12.5))
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3.0)))
							||((third_peak_amplitude/second_peak_amplitude)<=5.0*mean_amplitude_ringing
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+25))
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3.0))
							&&(third_peak_amplitude<=13)))
							||
							((third_peak_amplitude/first_peak_amplitude)<=1.7*mean_amplitude_ringing	/* SINGLE WAVEFORM */
							&&(second_peak_amplitude/first_peak_amplitude)<=2.9*mean_amplitude_ringing
							&&(train_position_of_second_peak_amplitude>=(train_position_of_first_peak_amplitude+3))
							&&(train_position_of_second_peak_amplitude<=(train_position_of_first_peak_amplitude+12))
							&&(train_position_of_third_peak_amplitude>=(train_position_of_first_peak_amplitude+5))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_first_peak_amplitude+30))))
						{	
							if((third_peak_amplitude/first_peak_amplitude)<=1.7*mean_amplitude_ringing	/* SINGLE WAVEFORM */
							&&(second_peak_amplitude/first_peak_amplitude)<=2.9*mean_amplitude_ringing
							&&(train_position_of_second_peak_amplitude>=(train_position_of_first_peak_amplitude+3))
							&&(train_position_of_second_peak_amplitude<=(train_position_of_first_peak_amplitude+12))
							&&(train_position_of_third_peak_amplitude>=(train_position_of_first_peak_amplitude+5))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_first_peak_amplitude+30)))
							{
								waveform_one_peak++;

								/*SINGLE*/
								fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID,first_peak_amplitude);
								fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);	
								find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
									&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
								if ((pulse_width<=0.8*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
								{
									fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
									fprintf(out_xyz_single,",%lf,%lf,%lf",x1,y1,h1);
									fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
								}
								else
								{
									fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
									fprintf(out_xyz_single,"%lf,%lf,%lf,%lf",pulse_width,x1,y1,h1);
									fprintf(out_param,"%d,1,%lf,%lf,%lf\n", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
								}
								sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
								sum_single_width=sum_single_width+pulse_width;
								fprintf(out_xyz,"%lf\n",incidence_angle);
								fprintf(out_xyz_single,"\n");	
							}
							else /*TWO_PEAK*/
							{
								waveform_two_peaks++;
					
								/*FIRST*/
								fprintf(out_xyz,"%d,1,2,%.0lf,",pulseID,first_peak_amplitude);
								find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
									&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
						
								if ((pulse_width<=0.8*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
								{
									fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
									fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted);
								}
								else
								{
									fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
									fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
								}
								fprintf(out_xyz,"%lf\n",incidence_angle);
					
								/*SECOND*/

								fprintf(out_xyz,"%d,2,2,%.0lf,",pulseID,second_peak_amplitude);
								find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
									&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
								if ((pulse_width<=0.8*mean_width_transmitted)&&(second_peak_amplitude<70)||(pulse_width==0))
								{
									fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
									fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
								}
								else
								{
									fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
									fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
								}
								fprintf(out_xyz,"%lf\n",incidence_angle);
							}
						}
						else			/* THREE-PEAK WAVEFORM */
						{
							waveform_three_peaks++;
					
							/*FIRST*/
							fprintf(out_xyz,"%d,1,3,%.0lf,",pulseID,first_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
					
							if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_param,"%d,3,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
								fprintf(out_param,"%d,3,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

					
							/*SECOND*/
							fprintf(out_xyz,"%d,2,3,%.0lf,",pulseID,second_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude,second_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

					
							/*THIRD*/
							fprintf(out_xyz,"%d,3,3,%.0lf,",pulseID,third_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude,third_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
						}
					}
			
					if ((train_position_of_first_peak_amplitude!=train_position_of_second_peak_amplitude)
						&&(train_position_of_second_peak_amplitude!=train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude!=train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude==train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude))
					{
						if ((((train_position_of_fourth_peak_amplitude>=(number_of_bins-0.5))				/*THREE PEAK WAVEFORM*/
							||((fourth_peak_amplitude/third_peak_amplitude)<=3.2*mean_amplitude_ringing
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+12))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))))
							||
							((fourth_peak_amplitude/third_peak_amplitude)<=4.0*mean_amplitude_ringing
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+8))
							&&fourth_peak_amplitude<=11))
							||
							((third_peak_amplitude/second_peak_amplitude)<=2.9*mean_amplitude_ringing		/*TWO PEAK WAVEFORM*/
							&&(fourth_peak_amplitude/second_peak_amplitude)<=2.4*mean_amplitude_ringing
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+12))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_second_peak_amplitude+4))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_second_peak_amplitude+20)))
							||
							((second_peak_amplitude/first_peak_amplitude)<=2.6*mean_amplitude_ringing /*SINGLE*/
							&&(third_peak_amplitude/first_peak_amplitude)<=1.4*mean_amplitude_ringing
							&&(fourth_peak_amplitude/first_peak_amplitude)<=1.4*mean_amplitude_ringing
							&&(train_position_of_second_peak_amplitude>=(train_position_of_first_peak_amplitude+4))
							&&(train_position_of_second_peak_amplitude<=(train_position_of_first_peak_amplitude+12))
							&&(train_position_of_third_peak_amplitude>=(train_position_of_first_peak_amplitude+5))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_first_peak_amplitude+22))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_first_peak_amplitude+9))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_first_peak_amplitude+30))))
						{
							if ((((train_position_of_fourth_peak_amplitude>=(number_of_bins-0.5))				/*THREE PEAK WAVEFORM*/
							||((fourth_peak_amplitude/third_peak_amplitude)<=3.2*mean_amplitude_ringing
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+12))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))))
							||
							((fourth_peak_amplitude/third_peak_amplitude)<=4.0*mean_amplitude_ringing
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+8))
							&&fourth_peak_amplitude<=10))
							||
							((third_peak_amplitude/second_peak_amplitude)<=2.9*mean_amplitude_ringing			/*TWO PEAK WAVEFORM*/
							&&(fourth_peak_amplitude/second_peak_amplitude)<=2.4*mean_amplitude_ringing
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+12))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_second_peak_amplitude+4))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_second_peak_amplitude+20))))
							{
								if (((train_position_of_fourth_peak_amplitude>=(number_of_bins-0.5))				/*THREE PEAK WAVEFORM*/
								||((fourth_peak_amplitude/third_peak_amplitude)<=3.2*mean_amplitude_ringing
								&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+12))
								&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))))
								||
								((fourth_peak_amplitude/third_peak_amplitude)<=4.0*mean_amplitude_ringing
								&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+3.5))
								&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+8))
								&&fourth_peak_amplitude<=10))
								{
									waveform_three_peaks++;
							
									/*FIRST*/
									fprintf(out_xyz,"%d,1,3,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*SECOND*/
	
									fprintf(out_xyz,"%d,2,3,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*THIRD*/

									fprintf(out_xyz,"%d,3,3,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
								else /*TWO PEAK WAVEFORM*/
								{
									waveform_two_peaks++;

									/*FIRST*/
									fprintf(out_xyz,"%d,1,2,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,2,%lf,%lf,%lf,", pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*SECOND*/
									fprintf(out_xyz,"%d,2,2,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<70)||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
							}
							else /*SINGLE*/
							{
								waveform_one_peak++;
	
								/*SINGLE*/
								fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID,first_peak_amplitude);
								fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);	
								find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
									&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
								if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
								{
									fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
									fprintf(out_xyz_single,",%lf,%lf,%lf",x1,y1,h1);
									fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
								}
								else
								{
									fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
									fprintf(out_xyz_single,"%lf,%lf,%lf,%lf",pulse_width,x1,y1,h1);
									fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
								}
								sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
								sum_single_width=sum_single_width+pulse_width;
								fprintf(out_xyz,"%lf\n",incidence_angle);
								fprintf(out_xyz_single,"\n");	
							}
						}
						else		 /* FOUR-PEAK WAVEFORM */
						{
							waveform_four_peaks++;

							/*FIRST*/
							fprintf(out_xyz,"%d,1,4,%.0lf,",pulseID,first_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
								fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
						
							/*SECOND*/
							fprintf(out_xyz,"%d,2,4,%.0lf,",pulseID,second_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
					
							/*THIRD*/
							fprintf(out_xyz,"%d,3,4,%.0lf,",pulseID,third_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

							/*FOURTH*/
							fprintf(out_xyz,"%d,4,4,%.0lf,",pulseID,fourth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude, fourth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
						}
					}

			
					if ((train_position_of_first_peak_amplitude!=train_position_of_second_peak_amplitude)
						&&(train_position_of_second_peak_amplitude!=train_position_of_third_peak_amplitude)
						&&(train_position_of_third_peak_amplitude!=train_position_of_fourth_peak_amplitude)
						&&(train_position_of_fourth_peak_amplitude!=train_position_of_fifth_peak_amplitude)
						&&(train_position_of_fifth_peak_amplitude==train_position_of_sixth_peak_amplitude))
					{
						if (((train_position_of_fifth_peak_amplitude>=(number_of_bins-0.5))				/* FOUR-PEAK WAVEFORM */
							||((fifth_peak_amplitude/fourth_peak_amplitude)<=2.7*mean_amplitude_ringing
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+12))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+5))))
							||
							((fifth_peak_amplitude/fourth_peak_amplitude)<=4.0*mean_amplitude_ringing
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+7))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+3.5))
							&&fifth_peak_amplitude<=13)
							||
							((((fourth_peak_amplitude/third_peak_amplitude)<=2.2*mean_amplitude_ringing) /* THREE-PEAK WAVEFORM*/
							&&((fifth_peak_amplitude/third_peak_amplitude)<=2.0*mean_amplitude_ringing)
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+4))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+10))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_third_peak_amplitude+5))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_third_peak_amplitude+14))))
							||
							((((third_peak_amplitude/second_peak_amplitude)<=3.2*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
							&&((fourth_peak_amplitude/second_peak_amplitude)<=2.2*mean_amplitude_ringing)
							&&((fifth_peak_amplitude/second_peak_amplitude)<=2.0*mean_amplitude_ringing)
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+11))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_second_peak_amplitude+15))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_second_peak_amplitude+25))))
							||
							(((second_peak_amplitude/first_peak_amplitude)<=2.1*mean_amplitude_ringing) /* SINGLE */
							&&((third_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing)
							&&((fourth_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing)
							&&((fifth_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing)))	
						{	
							if ((((fourth_peak_amplitude/third_peak_amplitude)<=2.2*mean_amplitude_ringing) /* THREE-PEAK WAVEFORM*/
							&&((fifth_peak_amplitude/third_peak_amplitude)<=2.0*mean_amplitude_ringing)
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+4))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+10))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_third_peak_amplitude+5))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_third_peak_amplitude+14)))
							||
							((((third_peak_amplitude/second_peak_amplitude)<=3.2*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
							&&((fourth_peak_amplitude/second_peak_amplitude)<=2.2*mean_amplitude_ringing)
							&&((fifth_peak_amplitude/second_peak_amplitude)<=2.0*mean_amplitude_ringing)
							&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3))
							&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+11))
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_second_peak_amplitude+15))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_second_peak_amplitude+25)))))
							{	
								if ((((third_peak_amplitude/second_peak_amplitude)<=3.2*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
								&&((fourth_peak_amplitude/second_peak_amplitude)<=2.2*mean_amplitude_ringing)
								&&((fifth_peak_amplitude/second_peak_amplitude)<=2.0*mean_amplitude_ringing)
								&&(train_position_of_third_peak_amplitude>=(train_position_of_second_peak_amplitude+3))
								&&(train_position_of_third_peak_amplitude<=(train_position_of_second_peak_amplitude+11))
								&&(train_position_of_fourth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
								&&(train_position_of_fourth_peak_amplitude<=(train_position_of_second_peak_amplitude+15))
								&&(train_position_of_fifth_peak_amplitude>=(train_position_of_second_peak_amplitude+5))
								&&(train_position_of_fifth_peak_amplitude<=(train_position_of_second_peak_amplitude+25))))
								{
									waveform_two_peaks++;					

									/*FIRST*/
									fprintf(out_xyz,"%d,1,2,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,2,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,2,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*SECOND*/
									fprintf(out_xyz,"%d,2,2,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
							
								}
								else /*THREE Peak*/
								{
									waveform_three_peaks++;

									/*FIRST*/
									fprintf(out_xyz,"%d,1,3,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*SECOND*/
									fprintf(out_xyz,"%d,2,3,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*THIRD*/
									fprintf(out_xyz,"%d,3,3,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
							}
							else 
							{
								if (((second_peak_amplitude/first_peak_amplitude)<=2.1*mean_amplitude_ringing) /* SINGLE */
								&&((third_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing)
								&&((fourth_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing)
								&&((fifth_peak_amplitude/first_peak_amplitude)<=1.2*mean_amplitude_ringing))
								{
									waveform_one_peak++;
									fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID,first_peak_amplitude);
									fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);	
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_xyz_single,",%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_xyz_single,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
									sum_single_width=sum_single_width+pulse_width;
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}

								else
								{
									waveform_four_peaks++;/* FOUR-PEAK WAVEFORM */

									/*FIRST*/
									fprintf(out_xyz,"%d,1,4,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);

									/*SECOND*/
									fprintf(out_xyz,"%d,2,4,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*THIRD*/
									fprintf(out_xyz,"%d,3,4,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*FOURTH*/
									fprintf(out_xyz,"%d,4,4,%.0lf,",pulseID,fourth_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude, fourth_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
							}
						}
				
						else /* FIVE PEAK WAVEFORM*/
						{
					
							waveform_five_peaks++;
					
							/* FIRST*/
							fprintf(out_xyz,"%d,1,5,%.0lf,",pulseID,first_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_param,"%d,5,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
								fprintf(out_param,"%d,5,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
					
							/* SECOND*/
							fprintf(out_xyz,"%d,2,5,%.0lf,",pulseID,second_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);


							/*THRID*/
							fprintf(out_xyz,"%d,3,5,%.0lf,",pulseID,third_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
					
							/*FOURTH*/
							fprintf(out_xyz,"%d,4,5,%.0lf,",pulseID,fourth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude,fourth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,0.9*mean_width_transmitted);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);


							/*FIFTH*/
							fprintf(out_xyz,"%d,5,5,%.0lf,",pulseID,fifth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_fifth_peak_amplitude,fifth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x5,y5,h5,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(fifth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x5,y5,h5);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x5,y5,h5);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
						}
					}
			
					if ((train_position_of_first_peak_amplitude!=train_position_of_second_peak_amplitude)
					&&(train_position_of_second_peak_amplitude!=train_position_of_third_peak_amplitude)
					&&(train_position_of_third_peak_amplitude!=train_position_of_fourth_peak_amplitude)
					&&(train_position_of_fourth_peak_amplitude!=train_position_of_fifth_peak_amplitude)
					&&(train_position_of_fifth_peak_amplitude!=train_position_of_sixth_peak_amplitude))
					{
						if (((train_position_of_sixth_peak_amplitude>=(number_of_bins-0.5))				/* FIVE-PEAK WAVEFORM */
							||((sixth_peak_amplitude/fifth_peak_amplitude)<=4.1*mean_amplitude_ringing
							&&(train_position_of_sixth_peak_amplitude<=(train_position_of_fifth_peak_amplitude+12))
							&&(train_position_of_sixth_peak_amplitude>=(train_position_of_fifth_peak_amplitude+3))))
							||
							(((fifth_peak_amplitude/fourth_peak_amplitude)<=2.5*mean_amplitude_ringing) /* FOUR-PEAK WAVEFORM*/
							&&((sixth_peak_amplitude/fourth_peak_amplitude)<=2.5*mean_amplitude_ringing)
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+4))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+10))
							&&(train_position_of_sixth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+5))
							&&(train_position_of_sixth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+15)))
							||
							(((fourth_peak_amplitude/third_peak_amplitude)<=1.9*mean_amplitude_ringing) /* THREE-PEAK WAVEFORM*/
							&&((fifth_peak_amplitude/third_peak_amplitude)<=1.5*mean_amplitude_ringing)
							&&((sixth_peak_amplitude/third_peak_amplitude)<=1.5*mean_amplitude_ringing) 
							&&(train_position_of_fourth_peak_amplitude>=(train_position_of_third_peak_amplitude+4))
							&&(train_position_of_fourth_peak_amplitude<=(train_position_of_third_peak_amplitude+6))
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_third_peak_amplitude+5))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_third_peak_amplitude+10.5))
							&&(train_position_of_sixth_peak_amplitude>=(train_position_of_third_peak_amplitude+10))
							&&(train_position_of_sixth_peak_amplitude<=(train_position_of_third_peak_amplitude+12)))
							||
							(((third_peak_amplitude/second_peak_amplitude)<=3.1*mean_amplitude_ringing)
							&&((fourth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
							&&((fifth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing)
							&&((sixth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing))
							||
							(((second_peak_amplitude/first_peak_amplitude)<=2.5*mean_amplitude_ringing)
							&&((third_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)
							&&((fourth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing) /* SINGLE WAVEFORM*/
							&&((fifth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)
							&&((sixth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)))
						{
							if (((train_position_of_sixth_peak_amplitude>=(number_of_bins-0.5))				/* FIVE-PEAK WAVEFORM */
							||((sixth_peak_amplitude/fifth_peak_amplitude)<=4.1*mean_amplitude_ringing
							&&(train_position_of_sixth_peak_amplitude<=(train_position_of_fifth_peak_amplitude+12))
							&&(train_position_of_sixth_peak_amplitude>=(train_position_of_fifth_peak_amplitude+3))))
							||
							(((fifth_peak_amplitude/fourth_peak_amplitude)<=2.5*mean_amplitude_ringing) /* FOUR-PEAK WAVEFORM*/
							&&((sixth_peak_amplitude/fourth_peak_amplitude)<=2.5*mean_amplitude_ringing)
							&&(train_position_of_fifth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+4))
							&&(train_position_of_fifth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+10))
							&&(train_position_of_sixth_peak_amplitude>=(train_position_of_fourth_peak_amplitude+5))
							&&(train_position_of_sixth_peak_amplitude<=(train_position_of_fourth_peak_amplitude+15))))
							{
								if ((train_position_of_sixth_peak_amplitude>=(number_of_bins-0.5))				/* FIVE-PEAK WAVEFORM */
								||((sixth_peak_amplitude/fifth_peak_amplitude)<=4.1*mean_amplitude_ringing
								&&(train_position_of_sixth_peak_amplitude<=(train_position_of_fifth_peak_amplitude+12))
								&&(train_position_of_sixth_peak_amplitude>=(train_position_of_fifth_peak_amplitude+3))))
								{
									waveform_five_peaks++;
	
									/* FIRST*/
									fprintf(out_xyz,"%d,1,5,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,5,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,5,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/* SECOND*/
									fprintf(out_xyz,"%d,2,5,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);


									/*THRID*/
									fprintf(out_xyz,"%d,3,5,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*FOURTH*/
									fprintf(out_xyz,"%d,4,5,%.0lf,",pulseID,fourth_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude,fourth_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);

									/*FIFTH*/
									fprintf(out_xyz,"%d,5,5,%.0lf,",pulseID,fifth_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_fifth_peak_amplitude,fifth_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x5,y5,h5,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(fifth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x5,y5,h5);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x5,y5,h5);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
						
								else /* FOUR PEAK WAVEFORM*/
								{
									waveform_four_peaks++;
						
									/*FIRST*/
									fprintf(out_xyz,"%d,1,4,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,4,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*SECOND*/
									fprintf(out_xyz,"%d,2,4,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*THIRD*/
									fprintf(out_xyz,"%d,3,4,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);

					
									/*FOURTH*/
									fprintf(out_xyz,"%d,4,4,%.0lf,",pulseID,fourth_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude, fourth_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
							}
							else
							{
								if ((((third_peak_amplitude/second_peak_amplitude)<=3.0*mean_amplitude_ringing)
								&&((fourth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
								&&((fifth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing)
								&&((sixth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing))
								||
								(((second_peak_amplitude/first_peak_amplitude)<=2.5*mean_amplitude_ringing)
								&&((third_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)
								&&((fourth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing) /* SINGLE WAVEFORM*/
								&&((fifth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)
								&&((sixth_peak_amplitude/first_peak_amplitude)<=1.0*mean_amplitude_ringing)))
								{
									if (((third_peak_amplitude/second_peak_amplitude)<=3.0*mean_amplitude_ringing)
									&&((fourth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing) /* TWO-PEAK WAVEFORM*/
									&&((fifth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing)
									&&((sixth_peak_amplitude/second_peak_amplitude)<=1.0*mean_amplitude_ringing))
									{
										waveform_two_peaks++;

										/*FIRST*/
										fprintf(out_xyz,"%d,1,2,%.0lf,",pulseID,first_peak_amplitude);
										find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
											&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
										if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
										{
											fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
											fprintf(out_param,"%d,2,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
										}
										else
										{
											fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
											fprintf(out_param,"%d,2,%lf,%lf,%lf,",pulseID, train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
										}
										fprintf(out_xyz,"%lf\n",incidence_angle);
					
										/*SECOND*/

										fprintf(out_xyz,"%d,2,2,%.0lf,",pulseID,second_peak_amplitude);
										find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
											&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
										if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
										{
											fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
											fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
										}
										else
										{
											fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
											fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
										}
										fprintf(out_xyz,"%lf\n",incidence_angle);

									}
									else
									{
										waveform_one_peak++;

										/*SINGLE*/
										fprintf(out_xyz,"%d,1,1,%.0lf,",pulseID,first_peak_amplitude);
										fprintf(out_xyz_single,"%d,1,%.0lf,",pulseID,first_peak_amplitude);	
										find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
											&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
										if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
										{
											fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
											fprintf(out_xyz_single,",%lf,%lf,%lf",x1,y1,h1);
											fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
										}
										else
										{
											fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
											fprintf(out_xyz_single,"%lf,%lf,%lf,%lf",pulse_width,x1,y1,h1);
											fprintf(out_param,"%d,1,%lf,%lf,%lf\n",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
										}
										sum_single_amplitude=sum_single_amplitude+first_peak_amplitude;
										sum_single_width=sum_single_width+pulse_width;
										fprintf(out_xyz,"%lf\n",incidence_angle);
										fprintf(out_xyz_single,"\n");	
									}
								}
								else /*THREE PEAK WAVEFORM*/
								{
									waveform_three_peaks++;
					
									/*FIRST*/
									fprintf(out_xyz,"%d,1,3,%.0lf,",pulseID,first_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
										fprintf(out_param,"%d,3,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);

									/*SECOND*/

									fprintf(out_xyz,"%d,2,3,%.0lf,",pulseID,second_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
										fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
					
									/*THIRD*/
				
									fprintf(out_xyz,"%d,3,3,%.0lf,",pulseID,third_peak_amplitude);
									find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
										&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
									if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
									{
										fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
									}
									else
									{
										fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
										fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
									}
									fprintf(out_xyz,"%lf\n",incidence_angle);
								}
							}
						}
						else /* SIX PEAK WAVEFORM */
						{
							waveform_six_peaks++;

							/*FIRST*/

							fprintf(out_xyz,"%d,1,6,%.0lf,",pulseID,first_peak_amplitude);

							find_exact_width(amplitude,number_of_bins,train_position_of_first_peak_amplitude, first_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x1,y1,h1,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(first_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x1,y1,h1);
								fprintf(out_param,"%d,6,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x1,y1,h1);
								fprintf(out_param,"%d,6,%lf,%lf,%lf,",pulseID,train_position_of_first_peak_amplitude,first_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);
					
							/*SECOND*/
		
							fprintf(out_xyz,"%d,2,6,%.0lf,",pulseID,second_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_second_peak_amplitude, second_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x2,y2,h2,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(second_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x2,y2,h2);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_second_peak_amplitude,second_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

							/*THIRD*/
		
							fprintf(out_xyz,"%d,3,6,%.0lf,",pulseID,third_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_third_peak_amplitude, third_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x3,y3,h3,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(third_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x3,y3,h3);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_third_peak_amplitude,third_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

							/*FOURTH*/
	
							fprintf(out_xyz,"%d,4,6,%.0lf,",pulseID,fourth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_fourth_peak_amplitude, fourth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x4,y4,h4,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(fourth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x4,y4,h4);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fourth_peak_amplitude,fourth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

							/*FIFTH*/
	
							fprintf(out_xyz,"%d,5,6,%.0lf,",pulseID,fifth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_fifth_peak_amplitude, fifth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x5,y5,h5,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(fifth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x5,y5,h5);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x5,y5,h5);
								fprintf(out_param,"%lf,%lf,%lf,", train_position_of_fifth_peak_amplitude,fifth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

					
							/*SIXTH*/

							fprintf(out_xyz,"%d,6,6,%.0lf,",pulseID,sixth_peak_amplitude);
							find_exact_width(amplitude,number_of_bins,train_position_of_sixth_peak_amplitude, sixth_peak_amplitude, 
								&pulse_width,&train_half_amplitude_first_exact,&train_half_amplitude_last_exact,out_xyz,x6,y6,h6,mean_width_transmitted);
							if ((pulse_width<=0.9*mean_width_transmitted)&&(sixth_peak_amplitude<(mean_amplitude_trans/4))||(pulse_width==0))
							{
								fprintf(out_xyz,"0,%lf,%lf,%lf,",x6,y6,h6);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_sixth_peak_amplitude,sixth_peak_amplitude,mean_width_transmitted/2.35482);
							}
							else
							{
								fprintf(out_xyz,"%lf,%lf,%lf,%lf,",pulse_width,x6,y6,h6);
								fprintf(out_param,"%lf,%lf,%lf\n", train_position_of_sixth_peak_amplitude,sixth_peak_amplitude,pulse_width/2.35482);
							}
							fprintf(out_xyz,"%lf\n",incidence_angle);

						}//six peak waveform
					} // check how many peak positions were found
				}//output non-disregarded waveforms
			}// end of loop for number of segments in a received waveform
		}  //end o reading the file 
	} //end of do loop to process the received waveforms
	while (!feof(in_fp));

	printf("\n\n\tProcessing of received waveforms is finished");
	fprintf(out_sum,"\n\n\tProcessing of received waveforms is finished\n");
	
	mean_single_amplitude=sum_single_amplitude/waveform_one_peak;
	mean_single_width=sum_single_width/waveform_one_peak;
	mean_vector_elevation=sum_vector_elevation/pulse_counter;
	
	fprintf(out_xyz," \n");
	fprintf(out_sum,"\n***********************************************************************\n");
	fprintf(out_sum,"\n* DATA INFORMATION *\n");
	fprintf(out_sum,"\n* Waveforms processed: \t%d *\n",pulse_counter-1);
	fprintf(out_sum,"* Disregarded waveforms: \t%d *\n",waveform_disregarded);
	fprintf(out_sum,"\n* Waveforms with one peak: \t%d *\n",waveform_one_peak);
	fprintf(out_sum,"* Waveforms with two peaks: \t%d *\n",waveform_two_peaks);
	fprintf(out_sum,"* Waveforms with three peaks: \t%d *\n",waveform_three_peaks);
	fprintf(out_sum,"* Waveforms with four peaks: \t%d *\n",waveform_four_peaks);
	fprintf(out_sum,"* Waveforms with five peaks: \t%d *\n",waveform_five_peaks);
	fprintf(out_sum,"* Waveforms with six peaks: \t%d *\n",waveform_six_peaks);
	fprintf(out_sum,"\n* Total number of points detected: %d   *\n",waveform_one_peak+2*waveform_two_peaks+3*waveform_three_peaks+4*waveform_four_peaks+5*waveform_five_peaks+6*waveform_six_peaks);
	
	total_number_of_points=waveform_one_peak+2*waveform_two_peaks+3*waveform_three_peaks+4*waveform_four_peaks+5*waveform_five_peaks+6*waveform_six_peaks;

	fprintf(out_sum,"\n* Mean ringing effect: \t\t\t\t%lf *\n",mean_amplitude_ringing);
	fprintf(out_sum,"* Noise to signal ratio (transmitted): \t\t%lf *\n", noise_estim/mean_amplitude_trans);
	
	fprintf(out_sum,"* Mean amplitude of the transmitted pulse: \t%lf *\n", mean_amplitude_trans);
	fprintf(out_sum,"* Mean width of the transmitted pulse: \t\t%lf *\n", mean_width_transmitted);
	fprintf(out_sum,"* Mean noise in transmitted waveforms: \t\t%lf *\n", noise_estim);	
	
	fprintf(out_sum,"\n* Sampling unit: \t\t\t\t%d *\n",Sampling_unit);
	fprintf(out_sum,"* Mean elevation vector: \t\t\t%lf *\n", mean_vector_elevation);
	
	fprintf(out_sum,"\n* Mean amplitude of single returns: \t\t%lf *\n",mean_single_amplitude);
	fprintf(out_sum,"* Mean width of single returns: \t\t%lf *\n",mean_single_width);

	fprintf(out_len,"%d\n", pulse_counter-1);
	fprintf(out_len,"%d\n", waveform_one_peak);
	fprintf(out_len,"%d\n", total_number_of_points);
	fprintf(out_len,"%d\n", Sampling_unit);
	fprintf(out_len,"%lf\n", mean_amplitude_trans);
	fprintf(out_len,"%lf\n", mean_width_transmitted);
	fprintf(out_len,"%lf\n", mean_single_amplitude);
	fprintf(out_len,"%lf\n", mean_single_width);
	fprintf(out_len,"%lf\n", noise_estim);
	fprintf(out_len,"%lf\n", mean_vector_elevation);
	
	
	printf("\n\n* Waveforms processed: %d   *\n",pulse_counter-1);
	printf("* Disregarded waveforms: %d *\n",waveform_disregarded);
	printf("\n* Waveforms with one peak: %d   *\n",waveform_one_peak);
	printf("* Waveforms with two peaks: %d   *\n",waveform_two_peaks);
	printf("* Waveforms with three peaks: %d *\n",waveform_three_peaks);
	printf("* Waveforms with four peaks: %d   *\n",waveform_four_peaks);
	printf("* Waveforms with five peaks: %d   *\n",waveform_five_peaks);
	printf("* Waveforms with six peaks: %d   *\n",waveform_six_peaks);
	fprintf(out_sum,"\n***********************************************************************");
	fprintf(out_sum, "\n\nPROCESSING COMPLETED!");
	printf("\n\nPROCESSING COMPLETED!");

	fclose(in_fp);
	fclose(out_xyz);
	fclose(out_xyz_single);
	fclose(out_param);

	return(0);

 } //end of main()

 

 